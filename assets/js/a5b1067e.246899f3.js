"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3363],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return u}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),c=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},m=function(e){var t=c(e.components);return r.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},l=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),l=c(n),u=a,h=l["".concat(p,".").concat(u)]||l[u]||d[u]||o;return n?r.createElement(h,s(s({ref:t},m),{},{components:n})):r.createElement(h,s({ref:t},m))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=l;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}l.displayName="MDXCreateElement"},941:function(e,t,n){n.r(t),n.d(t,{assets:function(){return m},contentTitle:function(){return p},default:function(){return u},frontMatter:function(){return i},metadata:function(){return c},toc:function(){return d}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),s=["components"],i={title:"tRPC",position:7,description:"See more about how to integrate with tRPC."},p=void 0,c={unversionedId:"main/frameworks/trpc",id:"main/frameworks/trpc",title:"tRPC",description:"See more about how to integrate with tRPC.",source:"@site/docs/main/frameworks/trpc.mdx",sourceDirName:"main/frameworks",slug:"/main/frameworks/trpc",permalink:"/serverless-adapter/docs/main/frameworks/trpc",editUrl:"https://github.com/H4ad/serverless-adapter/tree/main/www/docs/main/frameworks/trpc.mdx",tags:[],version:"current",frontMatter:{title:"tRPC",position:7,description:"See more about how to integrate with tRPC."},sidebar:"main",previous:{title:"NestJS",permalink:"/serverless-adapter/docs/main/frameworks/nestjs"}},m={},d=[{value:"Integrating with Adapters",id:"integrating-with-adapters",level:2},{value:"Default Context and Custom context",id:"default-context-and-custom-context",level:2}],l={toc:d};function u(e){var t=e.components,n=(0,a.Z)(e,s);return(0,o.kt)("wrapper",(0,r.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The following examples only work with tRPC over HTTP, you cannot use this framework to support websocket or subscriptions."))),(0,o.kt)("p",null,"First, you need to ensure you have the libs installed, so run this code:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm i --save @trpc/server\n")),(0,o.kt)("p",null,"Then, you need you just need to use the ",(0,o.kt)("a",{parentName:"p",href:"../../api/Frameworks/TrpcFramework"},"TrpcFramework")," when you create your adapter, like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="index.ts"',title:'"index.ts"'},"import * as trpc from '@trpc/server';\nimport { ServerlessAdapter } from '@h4ad/serverless-adapter';\nimport { TrpcFramework, TrpcAdapterContext, TrpcFrameworkOptions, BufferToJSObjectTransformer } from '@h4ad/serverless-adapter/lib/frameworks/trpc';\nimport { z } from 'zod';\n\ntype CustomContext = { currentDate: Date };\ntype TrpcContext = TrpcAdapterContext<CustomContext>;\n\nconst appRouter = trpc\n  .router<TrpcContext>()\n  .transformer(new BufferToJSObjectTransformer())\n  .query('getUser', {\n    input: z.string(),\n    async resolve(req) {\n      req.input; // string\n      return { id: req.input, name: 'Bilbo' };\n    },\n  })\n  .mutation('createUser', {\n    // validate input with Zod\n    input: z.object({ name: z.string().min(5) }),\n    async resolve({ input }) {\n      return {\n        created: true,\n        newName: input.name,\n      };\n    },\n  });\n\nconst frameworkOptions: TrpcFrameworkOptions<CustomContext> = {\n  createContext: () => ({ currentDate: new Date() }),\n};\n\nconst framework = new TrpcFramework<CustomContext>(frameworkOptions);\n\nexport const handler = ServerlessAdapter.new(appRouter)\n  .setFramework(framework)\n  // continue to set the other options here.\n  //.setHandler(new DefaultHandler())\n  //.setResolver(new PromiseResolver())\n  //.addAdapter(new AlbAdapter())\n  //.addAdapter(new SQSAdapter())\n  //.addAdapter(new SNSAdapter())\n  // after put all methods necessary, just call the build method.\n  .build();\n")),(0,o.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Always add the ",(0,o.kt)("a",{parentName:"p",href:"../../api/Frameworks/TrpcFramework/BufferToJSObjectTransformer"},"BufferToJSObjectTransformer")," because the input can be a buffer\nwhen you sent some JSON inside ",(0,o.kt)("inlineCode",{parentName:"p"},"body")," on mutation, so this transformer will be responsible to convert back to JS Object."))),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Need more examples? See more examples ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/H4ad/serverless-adapter-examples#trpc"},"here"),"."))),(0,o.kt)("h2",{id:"integrating-with-adapters"},"Integrating with Adapters"),(0,o.kt)("p",null,"This framework is a little special when dealing with request URLs because of the structure of tRPC."),(0,o.kt)("p",null,"So when you integrate with an adapter like ",(0,o.kt)("a",{parentName:"p",href:"/docs/main/adapters/aws/sqs"},"SQSAdapter"),", when you receive an event, the adapter will forward the request to ",(0,o.kt)("inlineCode",{parentName:"p"},"/sqs")," by default\nbut because of the structure of tRPC, the framework will change the request URL to just ",(0,o.kt)("inlineCode",{parentName:"p"},"sqs"),"."),(0,o.kt)("p",null,"With this behavior, to integrate with ",(0,o.kt)("a",{parentName:"p",href:"/docs/main/adapters/aws/sqs"},"SQSAdapter"),", you will create the following mutation:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="index.ts"',title:'"index.ts"'},"import type { SQSEvent } from 'aws-lambda';\nimport * as trpc from '@trpc/server';\nimport { TrpcAdapterContext, BufferToJSObjectTransformer } from '@h4ad/serverless-adapter/lib/frameworks/trpc';\nimport { z } from 'zod';\n\ntype TrpcContext = TrpcAdapterContext<unknown>;\n\nconst appRouter = trpc\n  .router<TrpcContext>()\n  .transformer(new BufferToJSObjectTransformer())\n  .mutation('sqs', {\n    input: z.object({\n      Records: z.array(z.any()),\n    }),\n    async resolve({ input, ctx }) {\n      if (ctx.getHeader('host') !== 'sqs.amazonaws.com')\n        throw new TRPCError({\n          code: 'UNAUTHORIZED',\n          message: 'Wrong host.',\n        });\n\n      const event = input as SQSEvent;\n\n      // Do whatever you want\n      // and you dont need to return nothing\n    },\n  });\n")),(0,o.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"About another adapters")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Never forget to check the host header as you could introduce a security hole when adding support for AWS Api Gateway and other adapters."))),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"You can see a working example ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/H4ad/serverless-adapter-examples/tree/master/src/trpc/aws/api-gateway-v2-and-sqs.entry.ts"},"here"),"."))),(0,o.kt)("h2",{id:"default-context-and-custom-context"},"Default Context and Custom context"),(0,o.kt)("p",null,"By default, we provide you with a few methods to get information from the request and modify the response,\nto learn more, take a look at ",(0,o.kt)("a",{parentName:"p",href:"../../api/Frameworks/TrpcFramework/TrpcAdapterBaseContext"},"TrpcAdapterBaseContext"),"."),(0,o.kt)("p",null,"Also, you can pass new properties to the context by setting the ",(0,o.kt)("inlineCode",{parentName:"p"},"createContext")," function inside the options,\nlike the code below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="index.ts"',title:'"index.ts"'},"import * as trpc from '@trpc/server';\nimport { ServerlessAdapter } from '@h4ad/serverless-adapter';\nimport { TrpcFramework, TrpcAdapterContext, BufferToJSObjectTransformer, TrpcFrameworkOptions } from '@h4ad/serverless-adapter/lib/frameworks/trpc';\n\ntype CustomContext = { potato: boolean };\ntype TrpcContext = TrpcAdapterContext<CustomContext>;\n\nconst appRouter = trpc\n  .router<TrpcContext>()\n  .transformer(new BufferToJSObjectTransformer())\n  .mutation('add', {\n    async resolve({ ctx }) {\n      // get the request url\n      const requestUrl = ctx.getUrl();\n\n      // this will change the status code of the request to 204.\n      ctx.setStatus(204);\n    },\n  });\n\nconst frameworkOptions: TrpcFrameworkOptions<TrpcContext> = {\n  // you can return a promise\n  createContext: () => Promise.resolve({ potato: true }),\n  // createContext: () => ({ potato: false }),\n};\n\nconst framework = new TrpcFramework<TrpcContext>(frameworkOptions);\n\nexport const handler = ServerlessAdapter.new(appRouter)\n  .setFramework(framework)\n  // continue to set the other options here.\n  //.setHandler(new DefaultHandler())\n  //.setResolver(new PromiseResolver())\n  //.addAdapter(new AlbAdapter())\n  //.addAdapter(new SQSAdapter())\n  //.addAdapter(new SNSAdapter())\n  // after put all methods necessary, just call the build method.\n  .build();\n")),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Is your application instance creation asynchronous? Look the ",(0,o.kt)("a",{parentName:"p",href:"./lazy"},"LazyFramework")," which helps you in asynchronous startup."))))}u.isMDXComponent=!0}}]);